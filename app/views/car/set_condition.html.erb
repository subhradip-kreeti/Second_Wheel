<div class="row overflow-hidden">
  <div class="col-lg-3">
    <%=render 'dashboard/sidebar'%>
  </div>
  <div class="col-lg-9">
    <h5 class="text-center mt-2 bg-light text-warning">Only cars yet to be verified will be shown here</h5>
    <div class="row mt-5">
      <% @car.each do |car| %>
        <% if car.condition == nil %>
          <div class="col-lg-4">
            <div class="card me-3 ms-3 mb-4" style="width: 18rem;background-color: #eee;">
              <%= image_tag car.image, class: "card-img-top pt-2 img-fluid" %>
              <div class="card-body">
                <h5 class="card-title"><%= car.brand.name %> <%= car.car_model.name %></h5>
                <p class="card-text"><%= car.variant %><br><%= car.kilometer_driven %> kms</p>
                <p class="card-text">Price: <%= car.price.present? ? car.price : "yet to update" %></p>
                <div class="d-flex card-text">
                  <span class="glyphicon glyphicon-map-marker"></span>
                  <p>Available at:<br><%= car.branch.name %><br><%= car.branch.city.name %></p>
                </div>
                <div class="d-flex flex-row">
                  <a type="button" class="btn btn-primary flex-fill me-1" target="blank" data-mdb-ripple-color="dark" href="/view_car/<%= car.id %>">
                    Learn more
                  </a>
                  <button type="button" class="btn btn-danger flex-fill ms-1 myModalBtn" data-car-id="<%= car.id %>">Verify</button>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<%# Modal %>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="myModalLabel">Enter price and condition to verify</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="co-md-6">
            <form>
              <div class="mb-3">
                <label for="condition" class="form-label">Condition</label>
                <select class="form-select" id="condition" required>
                  <option value="">Select condition</option>
                  <option value="Fair">Fair</option>
                  <option value="Good">Good</option>
                  <option value="Very_Good">Very Good</option>
                  <option value="Excellent">Excellent</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="price" class="form-label">Price</label>
                <input type="text" class="form-control" id="price" placeholder="Enter price" required>
              </div>
            </form>
          </div>
          <div class="co-md-6">
            <label for="rules" class="form-label">**Follow this Price Ranges</label>
            <table class="table">
              <thead>
                <tr>
                  <th>Condition</th>
                  <th>Price Range</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Fair</td>
                  <td>₹ 1,00,001 - ₹ 1,25,000</td>
                </tr>
                <tr>
                  <td>Good</td>
                  <td>₹ 1,25,001 - ₹ 1,50,000</td>
                </tr>
                <tr>
                  <td>Very Good</td>
                  <td>₹ 1,50,001 - ₹ 1,75,000</td>
                </tr>
                <tr>
                  <td>Excellent</td>
                  <td>₹ 1,75,001 - ₹ 2,00,000</td>
                </tr>
              </tbody>
            </table>

          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="verify-car" required>Verify</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('.myModalBtn').on('click', function() {
      $('#myModal').modal('show');
    });

    var modalBtns = document.querySelectorAll('.myModalBtn');
    var verifyBtn = document.getElementById('verify-car');
    var carId;

    modalBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        carId = btn.getAttribute('data-car-id');
        document.getElementById('myModal').classList.add('show');
        document.getElementById('myModal').style.display = 'block';

        console.log('Car ID:', carId);
      });
    });

    $('#verify-car').on('click', function() {
      var priceSelect = document.getElementById('price');
      var selectedPrice = priceSelect.value;

      var conditionSelect = document.getElementById('condition');
      var selectedOption = conditionSelect.options[conditionSelect.selectedIndex];
      var selectedCondition = selectedOption.value;

      if (!isValidPriceCondition(selectedPrice, selectedCondition)) {
        alert('Invalid price range with condition');
        return;
    }
      function isValidPriceCondition(price, condition) {
        price = price.replace(/,/g, '');
        if (condition === 'Fair' && (price < 100001 || price > 125000)) {
          return false;
        } else if (condition === 'Good' && (price < 125001 || price > 150000)) {
          return false;
        } else if (condition === 'Very_Good' && (price < 150001 || price > 175000)) {
          return false;
        } else if (condition === 'Excellent' && (price < 175001 || price > 200000)) {
          return false;
        }
        return true;
      }

      $.ajax({
        url: '/set_car_condition/verify',
        method: 'POST',
        data: {
          selected_price: selectedPrice,
          selected_condition: selectedCondition,
          car_id: carId,
          authenticity_token: $('meta[name="csrf-token"]').attr('content')
        },
        success: function(response) {
          // Handle success response
           location.reload();
        },
        error: function(xhr, status, error) {
          // Handle error response
        }
      });
    });
  });
</script>
